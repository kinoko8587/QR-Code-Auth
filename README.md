# QR Code Authentication System
QR Code authentication system, supporting millions of users to quickly clock in and out and authenticate their identity

## ðŸ§± 1. ç³»çµ±æž¶æ§‹ç¸½è¦½ï¼ˆHigh-level Architectureï¼‰
```
        [Mobile App]
             |
          [API Gateway]
             |
    +---------------------+
    |      QR Service     |  <â€” Main logic: validate, record, respond
    +---------------------+
         |         |
     [Cache]   [Message Queue]
         |         |
     [Database]  [Log Service, Notification Service]
```
## âš™ï¸ 2. QR Code è¨­è¨ˆèˆ‡é©—è­‰é‚è¼¯ï¼ˆæ ¸å¿ƒï¼‰
QR Code æ ¼å¼è¨­è¨ˆå»ºè­°ï¼ˆJWT æˆ– UUID ç‚º keyï¼‰ï¼š
QR Code å«ä»¥ä¸‹è³‡è¨Šï¼ˆå¯ base64 or JWT ç·¨ç¢¼ï¼‰ï¼š

uuid: å”¯ä¸€ IDï¼ˆé¿å…çŒœæ¸¬ï¼‰

exp: åˆ°æœŸæ™‚é–“æˆ³ï¼ˆå¦‚ 5 åˆ†é˜æœ‰æ•ˆï¼‰

event_id: æ‰€å±¬æ´»å‹•ç·¨è™Ÿ

nonce: éš¨æ©Ÿæ•¸é˜²é‡æ”¾

ðŸ“Œ ä¸€æ¬¡æ€§æ©Ÿåˆ¶å»ºè­°ï¼š

- å°‡ uuid å¯«å…¥ Redisï¼ŒTTL(Time To Live) è¨­ç‚º 5 åˆ†é˜ã€‚

- ä½¿ç”¨ Redis çš„ SETNXï¼ˆæˆ– Lua script ä¿è­‰åŽŸå­æ€§ï¼‰ä¾†é˜²æ­¢é‡è¤‡æ‰“å¡ã€‚

SETNX æ˜¯ Redis çš„ä¸€å€‹æŒ‡ä»¤ï¼Œæ„æ€æ˜¯ï¼š

ã€ŒSET if Not eXistsã€â†’ åªæœ‰ key ä¸å­˜åœ¨æ™‚ï¼Œæ‰å¯«å…¥ valueã€‚

ðŸŒ° ç¯„ä¾‹ï¼š
```
SETNX qr:uuid:abc123 "scanned"
```
å¦‚æžœ qr:uuid:abc123 ä¸å­˜åœ¨ï¼Œå°±å¯«å…¥ "scanned"ï¼Œä¸¦å›žå‚³ 1

å¦‚æžœå·²ç¶“å­˜åœ¨ï¼Œå°±ä»€éº¼éƒ½ä¸åšï¼Œå›žå‚³ 0

é€™å°±éžå¸¸é©åˆï¼š

ä¸€æ¬¡æ€§ QR Code é©—è­‰

Email é©—è­‰ç¢¼é™åˆ¶é‡ç™¼

é˜²æ­¢é‡è¤‡ä¸‹å–® / é‡è¤‡æ‰“å¡   

## ðŸš€ 3. é«˜ä½µç™¼èˆ‡ä½Žå»¶é²ç­–ç•¥ï¼ˆScaling & Performanceï¼‰
API Gateway + CDNï¼šå‰ç«¯éœæ…‹è³‡æºæˆ–éŽæœŸæç¤ºå¯åš edge caching

Rate Limiting / Bot Detectionï¼šåœ¨ gateway å±¤é€²è¡Œé˜²æ¿«ç”¨è¨­è¨ˆ

Redis + Bloom Filterï¼šåœ¨ Redis åŠ é€ŸæŸ¥è©¢æ˜¯å¦æŽƒæéŽæˆ–éŽæœŸï¼ˆæ¸›å°‘ DB hitï¼‰

* Bloom Filter æ˜¯ä¸€ç¨® ç©ºé–“æ•ˆçŽ‡æ¥µé«˜çš„æ©ŸçŽ‡åž‹è³‡æ–™çµæ§‹ï¼Œå¯ç”¨ä¾†åˆ¤æ–·æŸå€‹å…ƒç´ ã€Œæ˜¯å¦å¯èƒ½å­˜åœ¨ã€æˆ–ã€Œä¸€å®šä¸å­˜åœ¨ã€ã€‚
  - âœ¨ ç‰¹æ€§ï¼šå¯ä»¥å¿«é€Ÿæª¢æŸ¥ã€Œæœ‰æ²’æœ‰çœ‹éŽé€™å€‹ QR code / user / IPã€
  - è¨˜æ†¶é«”ä½”ç”¨å°ï¼Œå¯æ‰¿å—æ•¸ç™¾è¬æ¢è¨˜éŒ„
  - âœ… ç„¡èª¤åˆ¤ã€Œä¸å­˜åœ¨ã€ï¼Œä½† âŒ å¯èƒ½èª¤åˆ¤ã€Œå­˜åœ¨ã€
  - ç„¡æ³•åˆªé™¤å…ƒç´ ï¼ˆä½†æœ‰è®Šç¨®æ”¯æ´ï¼‰

Message Queue (Kafka/PubSub)ï¼šå°‡æ‰“å¡ç´€éŒ„ async å¯«å…¥ DBï¼Œé¿å…åŒæ­¥ç“¶é ¸

## ðŸ§® 4. å„²å­˜è¨­è¨ˆï¼ˆè³‡æ–™æ¨¡åž‹èˆ‡å¿«å–ï¼‰
Redisï¼š
qr:uuid:{uuid} = {user_id, event_id, timestamp}ï¼ˆTTL: 5 minsï¼‰

SETNX + Lua é˜²æ­¢ race condition

RDBï¼š
scan_records:

```
(id, user_id, event_id, scan_time, device_info, location)
```
å¯ä¾ event_id å»º partition æˆ– index æå‡æŸ¥è©¢æ•ˆèƒ½

Optional - DynamoDB:
è‹¥éœ€è¦è·¨åœ°åŸŸå¿«é€Ÿé©—è­‰ï¼Œå¯ä½¿ç”¨ DynamoDB + TTL ä¾†æ›¿ä»£ Redisï¼ˆæœ‰å…§å»º expiryï¼‰

## ðŸ” 5. å®‰å…¨æ€§è€ƒé‡
JWT ç°½åé©—è­‰ï¼šé˜²æ­¢ tampering
- ä»–å¯ä»¥è§£ç¢¼ payload ç„¶å¾Œæ”¹æˆæ–°çš„ uuidï¼Œä½†æ²’æœ‰æ­£ç¢ºçš„ secret key å°±ç„¡æ³•é‡ç®—ç°½åï¼Œå› æ­¤å¾Œç«¯é©—è­‰æœƒå¤±æ•— â†’ ä¿è­·äº†è³‡æ–™å®Œæ•´æ€§èˆ‡ä¾†æºå¯ä¿¡åº¦ã€‚

IP/device fingerprint + Location checkï¼šé¿å… QR é­æˆªåœ–æ¿«ç”¨

HTTPS onlyï¼šé¿å…ä¸­é–“äººæ”»æ“Š

QR code TTL è¨­çŸ­ï¼ˆå¦‚ 2-5 åˆ†é˜ï¼‰ï¼šç¸®å°æ”»æ“Šçª—å£

## ðŸ§© 6. Observability & Deployment
Tracingï¼šæ•´åˆ OpenTelemetryï¼ˆå‰ç«¯æŽƒæ â†’ API â†’ QR service â†’ Redis/DBï¼‰

Loggingï¼šè¨˜éŒ„æ¯æ¬¡æ‰“å¡æ˜¯å¦æˆåŠŸã€éŒ¯èª¤åŽŸå› 

Prometheus + Grafanaï¼šè§€å¯Ÿæ‰“å¡é‡ã€éŒ¯èª¤çŽ‡ã€è™•ç†å»¶é²

Deploymentï¼š

Cloud: AWS/GCP ECS + ALB

Auto Scalingï¼šæ ¹æ“š CPU/RPS å½ˆæ€§èª¿æ•´ QR Service

CI/CDï¼šGitHub Actions + Canary Release

## â›‘ 7. éŒ¯èª¤è™•ç†èˆ‡ UX è€ƒé‡
Redis timeout â†’ fallback æç¤º â€œè«‹ç¨å¾Œå†è©¦â€

éŒ¯èª¤åˆ†é¡žè™•ç†ï¼š

å·²æŽƒæéŽï¼šHTTP 409 + message

éŽæœŸï¼šHTTP 410

æ ¼å¼éŒ¯èª¤ / JWT é©—è­‰å¤±æ•—ï¼šHTTP 400

ç³»çµ±éŒ¯èª¤ï¼šHTTP 500

## æ¸¬è©¦
- å£“æ¸¬å·¥å…·ï¼šä½¿ç”¨ wrk æˆ– locust æ¨¡æ“¬è¬æ¬¡è«‹æ±‚
- æ•…æ„ä¸­æ–·éŽç¨‹ï¼Œè§€å¯Ÿ key æ˜¯å¦æ®˜ç•™
- æ¨¡æ“¬å¤šä½¿ç”¨è€…æ’ž UUIDï¼Œçœ‹æ˜¯å¦é€ æˆ double rewardï¼ˆrace conditionï¼‰
- 
## Question
### ðŸ” Q1. å¦‚ä½•åœ¨é«˜ä½µç™¼æƒ…å¢ƒä¸‹å¯¦ä½œ rate limitingï¼Ÿï¼ˆè¬› Redis æ–¹æ¡ˆï¼‰
âœ… å›žç­”ç¯„ä¾‹ï¼š
åœ¨é«˜ä½µç™¼ç’°å¢ƒä¸‹ï¼Œæˆ‘æœƒä½¿ç”¨ Redis + atomic operations å¯¦ä½œ rate limitingã€‚é€™æ¨£æ—¢èƒ½ä¿è­‰æ•ˆèƒ½ï¼Œåˆèƒ½é˜²æ­¢ race conditionã€‚

ðŸ‘£ æ ¸å¿ƒé‚è¼¯å¦‚ä¸‹ï¼š
go
```
// ç”¨æˆ¶ ID/IP åš keyï¼Œä¾‹å¦‚ï¼š
key := fmt.Sprintf("rate_limit:%s", userIP)
```
ä½¿ç”¨ INCR å¢žåŠ  counter

è‹¥æ˜¯ç¬¬ä¸€æ¬¡ï¼Œæ­é… EXPIRE è¨­å®šæ™‚é–“çª—

è‹¥ counter è¶…éŽé–¾å€¼ï¼Œå°±é™æµï¼ˆå¦‚ 429ï¼‰

â± Lua Script ç¢ºä¿åŽŸå­æ€§ï¼š
```
local current = redis.call("INCR", KEYS[1])
if tonumber(current) == 1 then
  redis.call("EXPIRE", KEYS[1], ARGV[1]) -- è¨­å®š TTL
end
return current
```
é€™ç¢ºä¿äº†ã€ŒåŠ  1ã€å’Œã€Œè¨­ TTLã€æ˜¯åŽŸå­çš„ï¼Œé¿å… race conditionã€‚

ðŸ§  å„ªé»žï¼š
Redis æ˜¯ in-memoryï¼Œè™•ç†é€Ÿåº¦æ¥µå¿«

ä½¿ç”¨ TTLï¼Œè‡ªå‹•éŽæœŸé‡‹æ”¾è¨˜æ†¶é«”

é«˜ä½µç™¼ä¸‹ä¸éœ€é »ç¹æ‰“ DB

ðŸ“¦ å»¶ä¼¸ï¼š
å¯ä»¥é‡å° IPã€user_idã€endpoint ä¸åŒå±¤ç´šè¨­ä¸åŒé™åˆ¶

é‡å°é‡è¦æœå‹™åŠ æ¬Šè™•ç†ï¼ˆå¦‚ç™»å…¥ vs æ‰¹é‡æŸ¥è©¢ï¼‰

### ðŸ¤– Q2. Bot æª¢æ¸¬éŒ¯åˆ¤æ€Žéº¼è™•ç†ï¼Ÿæœƒä¸æœƒèª¤å‚·çœŸå¯¦ç”¨æˆ¶ï¼Ÿ
âœ… å›žç­”ç¯„ä¾‹ï¼š
æ˜¯çš„ï¼Œé€™ç¢ºå¯¦æ˜¯ä¸€å€‹å¿…é ˆè™•ç†çš„é¢¨éšªã€‚æˆ‘æœƒé€éŽã€Œå¤šéšŽå±¤çš„æª¢æ¸¬æ©Ÿåˆ¶ã€+ã€Œç”¨æˆ¶å›žé¥‹å…¥å£ã€ä¾†å¹³è¡¡é€™å€‹å•é¡Œã€‚

ðŸ§  æˆ‘çš„ä½œæ³•åŒ…æ‹¬ï¼š
é¢¨éšªåˆ†æ•¸åˆ¶åº¦ï¼ˆRisk Scoreï¼‰
æ¯å€‹è«‹æ±‚è¨ˆç®—ä¸€å€‹ bot åˆ†æ•¸ï¼ˆä¾‹å¦‚ï¼š

å¿«é€Ÿé»žæ“Š + UA å¯ç–‘ + IP é»‘åå–® â†’ å¾—åˆ†é«˜

åˆ†æ•¸è¶…éŽ 80 æ‰ trigger é™åˆ¶å‹•ä½œï¼ˆå¦‚ CAPTCHAï¼‰

éžåŒæ­¥å°éŽ–èˆ‡äº‹å¾Œé‚„åŽŸ
æŸäº›å°éŽ–æ˜¯æš«æ™‚æ€§çš„ï¼Œä¸¦å…è¨±ç”¨æˆ¶ç”³è«‹è§£éŽ–ï¼ˆä¾‹å¦‚ç°¡è¨Šé©—è­‰ã€å®¢æœå¾©åŽŸï¼‰

ç°åå–® vs é»‘åå–®
ç°åå–®ç”¨æˆ¶æœƒè§¸ç™¼æ›´åš´æ ¼é™åˆ¶ï¼ˆå¦‚åŠ å…¥æ»‘å‹•é©—è­‰æˆ– email ç¢ºèªï¼‰
é»‘åå–®æ‰æœƒç›´æŽ¥æ‹’çµ•

âœ… ä½¿ç”¨è€…èª¤å‚·æ¡ˆä¾‹è™•ç†ï¼š
è‹¥åˆ¤å®šèª¤å‚·ï¼Œæˆ‘å€‘æœƒé€éŽé©—è­‰ç¢¼æˆ–è£œå……è³‡è¨Šé‚„åŽŸ access

åŒæ™‚è¨˜éŒ„é€™é¡žèª¤åˆ¤åšèª¿æ•´ï¼ŒæŒçºŒå¾®èª¿é¢¨æŽ§æ¨¡åž‹é–¾å€¼

### ðŸ™Œ Q3. ä½ å¦‚ä½•å¹³è¡¡ä½¿ç”¨è€…é«”é©—èˆ‡å®‰å…¨æ€§ï¼Ÿç”¨æˆ¶ä¸æƒ³ä¸€ç›´è¼¸å…¥é©—è­‰ç¢¼å–”ï¼Ÿ
âœ… å›žç­”ç¯„ä¾‹ï¼š
é€™æ˜¯ä¸€å€‹å¾ˆå¸¸è¦‹çš„å¯¦å‹™æŒ‘æˆ°ã€‚ç‚ºäº†åœ¨é«”é©—èˆ‡å®‰å…¨ä¹‹é–“å–å¾—å¹³è¡¡ï¼Œæˆ‘æœƒæŽ¡å–ã€Œé¢¨éšªæ„ŸçŸ¥å¼å®‰å…¨æ©Ÿåˆ¶ã€ï¼š

ðŸ§  ç­–ç•¥å¦‚ä¸‹ï¼š
å‹•æ…‹é©—è­‰ç­‰ç´šï¼ˆAdaptive Verificationï¼‰

ä½Žé¢¨éšªï¼šä¸é©—è­‰ï¼ˆå¦‚ç™»å…¥åœ°é»žç†Ÿæ‚‰ã€UA æ­£å¸¸ï¼‰

ä¸­é¢¨éšªï¼šæ»‘å‹•é©—è­‰ï¼ˆç„¡æ„Ÿï¼‰

é«˜é¢¨éšªï¼šSMS OTP / Email é©—è­‰

è¨˜æ†¶ä¿¡ä»»è¨­å‚™ / Token

ç¬¬ä¸€æ¬¡é©—è­‰å¾Œï¼Œç™¼æ”¾çŸ­æœŸ token æˆ–æ¨™è¨˜ã€Œå¯ä¿¡è¨­å‚™ã€

é€™æ¨£ä¸‹æ¬¡å°±ä¸éœ€å†é©—è­‰ï¼ˆé™¤éžç™»å…¥ç’°å¢ƒè®Šå‹•ï¼‰

Invisible CAPTCHA (v3)

ä½¿ç”¨ Google reCAPTCHA v3 è©•åˆ†ç³»çµ±

åªæœ‰çœŸçš„å¤ªå¯ç–‘æ‰è¦æ±‚é»žé¸äº¤é€šè™ŸèªŒ ðŸ˜†

è¡Œç‚ºåˆ†æž

ä½¿ç”¨è€…é»žæ“Šèˆ‡æ»‘å‹•ç¿’æ…£å¯è¨“ç·´æ¨¡åž‹å€åˆ† bot / çœŸäºº

ðŸŽ¯ å¯¦å‹™ä¸Šï¼Œæˆ‘å€‘æœƒé€²è¡Œ A/B Test ä¾†è¡¡é‡ä¸åŒé©—è­‰ç­–ç•¥å°è½‰æ›çŽ‡èˆ‡æ¿«ç”¨çŽ‡çš„å½±éŸ¿ï¼Œé€æ­¥æ‰¾åˆ°æœ€é©è§£ã€‚

- OpenTelemetry æˆ– DataDog è§€å¯Ÿ bot æ”»æ“Šæµé‡åˆ†ä½ˆï¼Œè®“é¢è©¦å®˜è¦ºå¾—ä½ æœ‰å¯è§€å¯Ÿæ€§æ¦‚å¿µ
- honeypot fieldï¼ˆå‡è¡¨å–®æ¬„ä½ï¼ŒçœŸç”¨æˆ¶ä¸æœƒå¡«ï¼Œbot æœƒï¼‰æ˜¯å¦ä¸€ç¨®ä½Žå¹²æ“¾ç­–ç•¥


